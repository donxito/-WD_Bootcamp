



# Node - Basic Authentication and Sessions

<!--

@todo: 
- provide boilerplate code with steps 1-4 (or at least 1-2) already done (students would clone, avoiding all those steps that by now they should know)


@Luis: follow students portal (~~highlighted, july21~~)

-->


- 2 parts:
  - Part 1: login process
  - Part 2: persistance (session & cookies)



## Login

- See "Step 4: functionality to login":
  https://github.com/Coding-Ninjas-Ironhack-Sept-2021/basic-auth-express-mongoose



## Data persistence using session and cookies

- See how, when we refresh the page, we loose the user details

- Explanation: HTTP is a stateless protocol
  - "every time a new request is sent from the client to the server, the information about the previous request is lost"
  - wikipedia: https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#HTTP_application_session



- Data persistance using session and cookies

  - Set cookie to 24h:

    ```
    cookie: {
      // ...
      maxAge: 1000 * 60 * 60 * 24 // 24h
    },
    ```


- Session management


<!-- 

  @luis: 
  - to keep the codealong a little bit shorter, apply this changes at the same time of the previous step (sessions + store sessions in DB, at the same time).
  - for that, 
    - install both packages together
      - npm i express-session connect-mongo
    - create "session.config.js" with the final result:
      - example with valid config: https://raw.githubusercontent.com/StrangerCodingThings-Ironhack-June-22/mongoose-express-CRUD-codealong/main/config/session.config.js

-->


  - OPTION 1 (December 2022):
    - code from Ironlauncher should work fine (it's a bit shorter than the settings we've used for previous cohorts)

    ```js
    const MONGO_URI = process.env.MONGODB_URI || "mongodb://127.0.0.1:27017/my-app";

    app.use(
      session({
        secret: process.env.SESSION_SECRET || "super hyper secret key",
        resave: false,
        saveUninitialized: false,
        store: MongoStore.create({
          mongoUrl: MONGO_URI,
        }),
      })
    );

    ```



  - OPTION 2 (previous cohorts):
    - to keep user logged-in in development (ie. when we change code and nodemon restarts the server), make sure the property "ttl" is not commented:

    ```
    store: MongoStore.create({
      mongoUrl: MONGO_URI,
      ttl: 60 * 60
    }),
    ```


    ```js
    const session = require('express-session');

    const MongoStore = require('connect-mongo');
    const mongoose = require('mongoose');

    module.exports = app => {
        app.set('trust proxy', 1);

        app.use(
            session({
                secret: process.env.SESS_SECRET,
                resave: true,
                saveUninitialized: false,
                cookie: {
                    sameSite: process.env.NODE_ENV === 'production' ? 'none' : 'lax',
                    secure: process.env.NODE_ENV === 'production',
                    httpOnly: true,
                    maxAge: 1000 * 60 * 60 * 24 // 24h
                },
                store: MongoStore.create({
                    mongoUrl: process.env.MONGODB_URI || 'mongodb://127.0.0.1/library-project',
                    ttl: 60 * 60 * 24 // 60sec * 60min * 24h => 1 day
                })
            })
        );
    };
    ```




## FAQs

- Why we need `process.env.SESS_SECRET`?
  - It is used to generate a random session id and be able to check that this id was actually generated by the server
  - ie. "digitally sign" the value of the cookie 
  - https://stackoverflow.com/questions/64667592/what-is-the-purpose-of-the-secret-in-express-session-middleware




## Logout





## Bonus & Extra challenges:

- Display "Logout" button only if user is logged-in.

- Implement header with:
  - If user is logged-in: display the message "Welcome ${username}" + Logut button
  - If user is logged-out: display "Register" + "Login" buttons


  - Hint: 
    - we need to pass info to all routes
    - see here: https://expressjs.com/en/api.html#res.locals


    ```javascript
    res.locals.pizza = true;
    ```


    ```javascript
    app.use((req, res, next) => {
      res.locals.session = req.session; // allow access to session data from layout.hbs
      next()
    });
    
    ```

    