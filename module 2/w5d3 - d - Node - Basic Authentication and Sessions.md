



# Node - Basic Authentication and Sessions

<!--

@todo: 
- provide boilerplate code with steps 1-4 (or at least 1-2) already done (students would clone, avoiding all those steps that by now they should know)


@Luis: follow students portal

-->


- 2 parts:
  - Part 1: login process
  - Part 2: persistance (session & cookies)



## Login

- (README) See "Step 4: functionality to login":
  https://github.com/Coding-Ninjas-Ironhack-Sept-2021/basic-auth-express-mongoose/blob/main/README.md





## Data persistence using session and cookies

- See how, when we refresh the page, we loose the user details

  Visit in the browser: http://localhost:3000/user-profile

  ```js
    <button>
      <a href="/user-profile">Reload the page</a>
    </button>
  ```


- Explanation: HTTP is a stateless protocol
  - "every time a new request is sent from the client to the server, the information about the previous request is lost"
  - wikipedia: https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#HTTP_application_session





- Data persistance using session and cookies



<!-- 

  @luis: 
  - to keep the codealong a little bit shorter, apply this changes at the same time of the previous step (sessions + store sessions in DB, at the same time).

-->


Install dependencies:
 - `npm i express-session connect-mongo`



Create `config/session.config.js`:

  - Example: https://github.com/ironhack-tech-trash-july2023/techtrash-library-project/blob/main/config/session.config.js
  - Notes:
    - Will create a session cookie.
    - These are similar settings as ironlauncher.
    <!-- - we prob. don't need "trust proxy" anymore -->



Require in app.js:

```js
  const app = express();
  require("./config")(app);

  require('./config/session.config')(app); // <<<<<<<<< Add this line
```





## FAQs

- Why we need `process.env.SESS_SECRET`?
  - It is used to generate a random session id and be able to check that this id was actually generated by the server
  - ie. "digitally sign" the value of the cookie 
  - https://stackoverflow.com/questions/64667592/what-is-the-purpose-of-the-secret-in-express-session-middleware




## Logout


```js
router.post('/logout', (req, res, next) => {
  req.session.destroy(err => {
    if (err) next(err);
    res.redirect('/');
  });
});
```

```hbs
  <form id="logout-form" action="/logout" method="POST">
    <button>Logout</button>
  </form>
```


## Bonus: update navbar based on user status

- Implement header with:
  - If user is logged-in: display the message "Welcome ${username}" + Logout button
  - If user is logged-out: display only "Register" + "Login" links


  - Hint: 
    - we need to access the info from req.session from all views
    - since we don't want to pass it to each view, we can use res.locals
    - see here: https://expressjs.com/en/api.html#res.locals


    ```js
    res.locals.pizza = true;
    ```


Ex. in app.js you can add something like this:

    ```js
    app.use((req, res, next) => {
      res.locals.session = req.session; // allow access to session data from layout.hbs
      next()
    });
    
    ```

    